# dbus-autosleep Service

Victron Venus service for switching off the ESS inverter when not needed


### Purpose

This service is meant to be run on a Victron GX device, e.g. a MultiPlus-II GX, or a Raspberry Pi with Venus OS. It is to be used in a setup with a Victron ESS and AC-coupled PV.

The Python script cyclically checks the power drawn from the grid, the power generated by PV, the PV inverter's state and the internal state of the ESS (charge/feed-in allowed) to switch the ESS inverter off when it is not needed in order to reduce stand-by power consumption.

_Limitation:_ Currently, only loads on the grid side of the ESS are considered. Loads connected to the AC outputs of the ESS inverter are not considered and will lead to strange behaviour.

This service has been built for and tested with a Victron MultiPlus-II 5000 GX and a SolarEdge SE9K. The grid meter readings are fetched from the SolarEdge grid meter using [dbus-solaredge](https://github.com/h4ckst0ck/dbus-solaredge). In theory, it might work also with other ESS inverters and/or PV inverters, but I never tested this.


### Behaviour

The script separately calculates a _charge request_ and a _feed-in request_ and then uses them to determine the desired mode.

#### Input values

The following values are used as input for the decision:

* The charge disable from Victron's internal Hub4 control, which disables charging when the battery is full.
* The feed-in disable from Victron's internal Hub4 control, which disables feed-in when the battery is below the applicable SoC limit.
* The PV inverter's status
* The residual load, e.g. the load not supplied by PV, calculated from:
  * the power drawn from the grid, plus
  * the power generated by PV, minus
  * the power drawn by the ESS inverter.

#### Charge request

The charge request is set if

* the Victron Hub4 control allows charging (`/Hub4/DisableCharge` is not set), and
* excess PV power is currently available (i.e. the residual load is below _CHARGE_THRESHOLD_), and
* the PV inverter is currently active

for more than _STABLE_TIMER_.

It is reset if

* the Victron Hub4 control does not allow charging, or
* excess PV power has never been available continuously for _THRESHOLD_DEBOUNCE_ within the _CHARGE_TIMEOUT_, or
* the PV inverter is not active

for more than _STABLE_TIMER_.

The timeout prevents the ESS inverter to remain active when there is nothing to do for a long time. When the Victron control disables the charging or the PV is not available, the charge request is reset without timeout.

#### Feed-in request

The feed-in request is set if

* the Victron Hub4 control allows feed-in (`/Hub4/DisableFeedIn` is not set), and
* PV is currently not able to supply the load (i.e. the residual load is above _FEED_IN_THRESHOLD_)

for more than _STABLE_TIMER_.

It is reset if

* the Victron Hub4 control does not allow feed-in, or
* no power demand existed continuously for _THRESHOLD_DEBOUNCE_ within the _FEED_IN_TIMEOUT_

for more than _STABLE_TIMER_.

The timeout prevents the ESS inverter to remain active when there is nothing to do for a long time. When the Victron control disables the feed-in, the feed-in request is reset without timeout.

#### Mode output

If either the charge request or the feed-in request is set, the target mode is on.

If the mode output is enabled and the script has not changed the mode for _LOCK_TIME_ (and is running for at least _LOCK_TIME_), the mode of the ESS inverter is set. If the time is not elapsed yet, the mode is changed only after it is elapsed. This is a precaution to avoid frequent mode changes possibly damaging the ESS inverter.


### Configuration

You need to set the dbus paths for your system setup in the dbus-autosleep.py as needed:

```
# dbus path for Victron energy storage system
ESS_PATH = 'com.victronenergy.vebus.ttyS3'

# dbus path for grid meter
GRID_METER_PATH = 'com.victronenergy.grid.grid_id00'

# dbus path for PV inverter
PV_INVERTER_PATH = 'com.victronenergy.pvinverter.pv0.pvinverter_id00'
```

The correct paths can easily be found using the `dbus-spy` tool.

The following paramters can be adjusted as needed:

```
# Debounce time for charge/feed-in timeouts [s]
THRESHOLD_DEBOUNCE = 10

# Feed-in timer to disable inverter [s]
FEED_IN_TIMEOUT = 3600

# Grid threshold for inverter activation [W]
FEED_IN_THRESHOLD = 100

# Charge timer to disable charger [s]
CHARGE_TIMEOUT = 3600

# Grid threshold for charger activation [W]
CHARGE_THRESHOLD = -100

# Stabilisation time for feed in or charge request [s]
STABLE_TIMER = 60

# Minimum time between changes of inverter mode [s]
LOCK_TIME = 600
```


### Installation

1. You need root access to your GX Device (https://www.victronenergy.com/live/ccgx:root_access)

2. Copy the files to the /data folder on your venus:

   - /data/dbus-autosleep/dbus-autosleep.py
   - /data/dbus-autosleep/enable-output.sh
   - /data/dbus-autosleep/disable-output.sh
   - /data/dbus-autosleep/kill_me.sh
   - /data/dbus-autosleep/service/run
   - /data/dbus-autosleep/service/log/run

3. Set permissions for files:

   `chmod 755 /data/dbus-autosleep/service/run`
   
   `chmod 755 /data/dbus-autosleep/service/log/run`
   
   `chmod 744 /data/dbus-autosleep/*.sh`

4. Add symlinks for auto starting:

   `ln -s /data/dbus-autosleep/service/ /service/dbus-autosleep`
   
   `ln -s /data/dbus-autosleep/service/ /opt/victronenergy/service/dbus-autosleep`

   The supervisor should automatically start this service within seconds, if not simply reboot your system.

5. By default, the service's output is disabled, i.e. the service checks the situation and calculates the recommended mode, but does not set it automatically.

   To enable the service, run the script `/data/dbus-autosleep/enable-output.sh`.
   
   If you want the disable the mode output again, you can use the script `/data/dbus-autosleep/disable-output.sh`.


### Upgrading Venus OS

If you are upgrading your Venus OS you will have to re-add the symlink for autostarting the python script (Repeat step 4 from the above installation instructions).


### Debugging

You can check the status of the service with svstat:\
`svstat /service/dbus-autosleep`

It will show something like this:\
`/service/dbus-autosleep: up (pid 8179) 746 seconds`

If the number of seconds is always a small number (<10), it means that the service crashes and gets restarted all the time.

You could also take a look at the log-file:\
`tail -f /var/log/dbus-autosleep/current`\
and see if there are any error messages.

When you think that the script crashes, start it directly from the command line:\
`python /data/dbus-autosleep/dbus-autosleep.py`\
and see if it throws any error messages.

When the script is successfully running, it publishes some debug values on the dbus on the path `com.victronenergy.debug.dbus_autosleep`. These can be observed e.g. with the `dbus-spy`. 


#### Restart the script

If you want to restart the script, for example after changing it, just run the following command:\
`/data/dbus-autosleep/kill_me.sh`

The supervisor will restart the script within a few seconds.


### Credits

I have shamelessly copied and adapted the code (including this readme) from https://github.com/h4ckst0ck/dbus-solaredge.

Victron Energy's extensive documentation on [their dbus values](https://github.com/victronenergy/venus/wiki/dbus) and their [commandline development guide](https://github.com/victronenergy/venus/wiki/commandline---development) has been very helpful during development.
